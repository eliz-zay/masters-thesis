# Master's Thesis. LLVM Obfuscator

## Setup

### Build

`docker build -t obf -f Dockerfile .` - build Docker image.

### Run

Dockerized obfuscator compiles a C program, obfuscates it, and produces a final binary file. The target C file is copied from the host machine to `/app/in/target.c` inside a container. Host output directory is linked to `/app/out` inside a Docker container, and **the obfuscated binary is to be generated in <full_path_to_output_dir>/<output_file.out>**.

```shell
  docker run \
    -v <full_path_to_src_file.c>:/app/in/target.c \
    -v <full_path_to_output_dir>:/app/out \
    --rm obf \
    <output_file.out>
```

For example, this command obfuscates `/path/to/target.c` and generates `/path/to/obfuscated/out.out`:
```shell
  docker run \
    -v /path/to/target.c:/app/in/target.c \
    -v /path/to/obfuscated:/app/out \
    --rm obf \
    out.out
```

## Obfuscation

### Annotations
- `flatten` - Control Flow Flattening
- `bogus-switch` - Bogus Control Flow for `switch` statements, generated by Control Flow Flattening. *It complements Control Flow Flattening. Please, use either `flatten`, or `flatten` with `bogus-switch`*
- `function-merge` - Function Merging, please specify for multiple functions at once
- `mba` - Instruction Substitution with Mixed Boolean-Arithmetic expressions

> Important notes:
> - Make sure to add `__attribute__((noinline))` for every obfuscated target function. C compilers automatically inline function calls, and then function obfuscation has no effect in the resulted binary because the obfuscated functions are in fact never called.   
> - For Function Merging, make sure target functions are `static`, meaning they have internal linkage. Otherwise, merging is not applied for safety reasons.

### Example
```
__attribute__((noinline))
__attribute__((annotate("flatten")))
__attribute__((annotate("bogus-switch")))
__attribute__((annotate("mba")))
__attribute__((annotate("function-merge")))
static void foo(int num) { /* ... */ }

__attribute__((noinline))
__attribute__((annotate("mba")))
__attribute__((annotate("function-merge")))
static void bar() { /* ... */ }
```

## Notes

For demonstration and compatibility purposes, current Docker setup encapsulates both compilation and obfuscation of C programs, based on `zig` compiler and LLVM IR-level optimizer. In general, the obfuscator is compatible with other high-level programming languages supported by LLVM compiler suite, and the target program needs to be compiled to IR code using a corresponding compiler and then obfuscated by LLVM `opt` with the obfuscation passes, as described in the [script](docker/run.sh).
